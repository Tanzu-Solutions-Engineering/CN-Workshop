ifdef::env-github[]
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
:spring-boot-version: 2.4.8
:spring-cloud-services-dependencies-version: 2.4.1
:spring-cloud-dependencies-version: 2020.0.3


= Enhancing with Metrics

== Overview

[.lead]
Spring Boot includes a number of additional features to help you monitor and manage your application when it’s pushed to production. You can choose to manage and monitor your application using HTTP and JMX endpoints. Auditing, health and metrics gathering can be automatically applied to your application.

== Set up the Actuator

Spring Boot includes a number of additional features to help you monitor and manage your application when it’s pushed to production. These features are added by adding `spring-boot-starter-actuator` to the classpath.  During our initial project setup with https://start.spring.io[Spring Initializr] we've already included that.

. Verify the Spring Boot Actuator dependency is listed in Maven `dependencies`:
+
.cloud-native-spring/pom.xml
[source,xml]
----
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
----

. By default Spring Boot will use Spring Security to protect these management endpoints (which is a good thing!)  Though you wouldn't want to disable this in production, we'll do so in this sample app to make demonstration a bit easier and simpler.
+
Add the following to your Spring Boot configuration:
+
.cloud-native-spring/src/main/resources/application.yml
[source,yaml]
----
management:
  endpoints:
    web:
      exposure:
        include: '*'
----

. Run the updated application:
+
[source,bash]
----
CN-Workshop/labs/my_work/cloud-native-spring $ ./mvnw spring-boot:run
----
+
Try out the following endpoints. The output is omitted here because it can be quite large:
+
http://localhost:8080/actuator::
Displays a complete list of the available endpoints.

http://localhost:8080/actuator/health::
Displays Application and Datasource health information.  This can be customized based on application functionality, which we'll do later.

http://localhost:8080/actuator/beans::
Dumps all of the beans in the Spring context.

http://localhost:8080/actuator/configprops::
Displays a collated list of all @ConfigurationProperties.

http://localhost:8080/actuator/env::
Dumps the application’s shell environment as well as all Java system properties.

http://localhost:8080/actuator/mappings::
Dumps all URI request mappings and the controller methods to which they are mapped.

http://localhost:8080/actuator/threaddump::
Performs a thread dump.

. Stop the _cloud-native-spring_ application.

== Include Version Control Info

Spring Boot provides a http://localhost:8080/actuator/info[/info] endpoint that allows the exposure of arbitrary metadata. By default this information is empty, however, we can use _actuator_ to expose information about the specific build and version control coordinates for a given deployment.

. The `git-commit-id-plugin` adds Git branch and commit coordinates to the http://localhost:8080/actuator/info[/info] endpoint.
+
Add the `git-commit-id-plugin` to Maven build plugins:
+
.cloud-native-spring/pom.xml
[source,xml]
----
<project>
  [...]
  <build>
    <plugins>
      [...]
      <plugin>
        <groupId>io.github.git-commit-id</groupId>
        <artifactId>git-commit-id-maven-plugin</artifactId>
        <configuration>
          <dotGitDirectory>../../../.git</dotGitDirectory>
          <offline>true</offline>
        </configuration>
      </plugin>
      [...]
    </plugins>
  </build>
  [...]
</project>
----
+
NOTE: The path `../../../.git` refers to the `.git` directory at the root of the lab materials repo. When using in your own project you'll need to adjust the path to your projects `.git` folder location.
+
Completed Maven configuration:
+
.cloud-native-spring/pom.xml
[source,xml,subs="verbatim,attributes"]
----
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>io.pivotal</groupId>
  <artifactId>cloud-native-spring</artifactId>
  <version>0.0.1-SNAPSHOT</version>
  <packaging>jar</packaging>

  <name>cloud-native-spring</name>
  <description>Demo project for Spring Boot</description>

  <parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>{spring-boot-version}</version>
    <relativePath/> <!-- lookup parent from repository -->
  </parent>

  <properties>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <java.version>1.8</java.version>
  </properties>

  <dependencies>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-data-rest</artifactId>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <dependency>
      <groupId>com.h2database</groupId>
      <artifactId>h2</artifactId>
      <scope>runtime</scope>
    </dependency>
    <dependency>
      <groupId>mysql</groupId>
      <artifactId>mysql-connector-java</artifactId>
      <scope>runtime</scope>
    </dependency>
    <dependency>
      <groupId>org.springframework.boot</groupId>
      <artifactId>spring-boot-starter-test</artifactId>
      <scope>test</scope>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
      </plugin>
      <plugin>
       <groupId>io.github.git-commit-id</groupId>
       <artifactId>git-commit-id-maven-plugin</artifactId>
        <configuration>
          <dotGitDirectory>../../../.git</dotGitDirectory>
          <offline>true</offline>
        </configuration>
      </plugin>
    </plugins>
  </build>


</project>
----

. Run the _cloud-native-spring_ application:
+
[source,bash]
----
CN-Workshop/labs/my_work/cloud-native-spring $ ./mvnw spring-boot:run
----

. Browse to the http://localhost:8080/actuator/info[info] endpoint. Git commit information is now included:
+
[source,json]
----
{
  "git" : {
    "commit" : {
      "time" : "2017-11-08T16:14:50.000+0000",
      "id" : "0966076"
    },
    "branch" : "master"
  }
}
----

. Stop the _cloud-native-spring_ application
+
*What Just Happened?*
+
By including the `git-commit-id-plugin`, details about git commit information will be included in the http://localhost:8080/actuator/info[/info] endpoint. Git information is captured in a `git.properties` file that is generated with the build.
+
For reference, review the generated file:
+
.cloud-native-spring/target/classes/git.properties
   
[source,txt]
----
#Generated by Git-Commit-Id-Plugin
#Wed Nov 08 10:14:59 CST 2017
git.branch=master
git.build.host=user.local
git.build.time=2017-11-08T10\:14\:59-0600
git.build.user.email=user@example.com
...
----

== Include Build Info

. Add the following properties to your Spring Boot configuration:
+
.cloud-native-spring/src/main/resources/application.yml
[source,yaml]
----
info: # add this section
  build:
    artifact: @project.artifactId@
    name: @project.name@
    description: @project.description@
    version: @project.version@
----
+
These will add the project’s Maven coordinates to the http://localhost:8080/actuator/info[/info] endpoint. The Spring Boot Maven plugin will cause them to automatically be replaced in the assembled JAR.
+
NOTE: If Spring Tool Suite reports a problem with the application.yml due to @ character the problem can safely be ignored.  If you _really_ want to git rid of the error message, wrap the values in quotes. Example: `artifact: "@project.artifactId@"`

. Build and run the cloud-native-spring application:
+
[source,bash]
----
CN-Workshop/labs/my_work/cloud-native-spring $ ./mvnw spring-boot:run
----

. Browse to the http://localhost:8080/actuator/info[/info] endpoint. Build information is now included:
+
[source,json]
----
{
  "build" : {
    "artifact" : "cloud-native-spring",
    "name" : "cloud-native-spring",
    "description" : "Demo project for Spring Boot",
    "version" : "0.0.1-SNAPSHOT"
  },
  "git" : {
    "commit" : {
      "time" : "2017-11-08T16:14:50.000+0000",
      "id" : "0966076"
    },
    "branch" : "master"
  }
}
----

. Stop the _cloud-native-spring_ application.
+
*What Just Happened?*
+
We have mapped Maven properties from the `pom.xml` into the http://localhost:8080/actuator/info[/info] endpoint.
+
Read more about exposing data in the http://localhost:8080/actuator/info[/info] endpoint http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready[here]

== Health Indicators

Spring Boot provides a http://localhost:8080/actuator/health[/health] endpoint that exposes various health indicators that describe the health of the given application.

Normally, when Spring Security is not enabled, the http://localhost:8080/actuator/health[/health] endpoint will only expose an UP or DOWN value.

[source,json]
----
{
  "status": "UP"
}
----

. Normally the health endpoint just indicates a single value to describe the condition of the app.  For this lab we will ask actuator to provide some addition information.
+
Add the following to your Spring Boot configuration:
+
.cloud-native-spring/src/main/resources/application.yml
[source,yaml]
----
management:
  endpoint:
    health:
      show-details: always
----

. Build and run the _cloud-native-spring_ application:
+
[source,bash]
----
CN-Workshop/labs/my_work/cloud-native-spring $ ./mvnw spring-boot:run
----

. Browse to the http://localhost:8080/actuator/health[/health] endpoint. Out of the box is a `DiskSpaceHealthIndicator` that monitors health in terms of available disk space. Would your Ops team like to know if the app is close to running out of disk space? `DiskSpaceHealthIndicator` can be customized via `DiskSpaceHealthIndicatorProperties`. For instance, setting a different threshold for when to report the status as DOWN. 
Increase the threshold by setting the approriate property in `application.yml`
+
[source,json]
----
management:
  health:
    diskspace:
      threshold: 200000MB
----

. Restart the the _cloud-native-spring_ application. Revisting the http://localhost:8080/actuator/health[/health] endpoint, should result in the application reporting a DOWN status.

. Let's create a custom health indicator that will randomize the health check.
+
Create the class `io.pivotal.cloudnativespring.FlappingHealthIndicator` and into it paste the following code:
+
.cloud-native-spring/src/main/java/io/pivotal/cloudnativespring/FlappingHealthIndicator.java
[source,java,numbered]
----
package io.pivotal.cloudnativespring;

import java.util.Random;

import org.springframework.boot.actuate.health.Health;
import org.springframework.boot.actuate.health.HealthIndicator;
import org.springframework.stereotype.Component;

@Component
public class FlappingHealthIndicator implements HealthIndicator {

    private Random random = new Random(System.currentTimeMillis());

    @Override
    public Health health() {
        int result = random.nextInt(100);
        if (result < 50) {
            return Health.down().withDetail("flapper", "failure").withDetail("random", result).build();
        } else {
            return Health.up().withDetail("flapper", "ok").withDetail("random", result).build();
        }
    }
}
----

. Build and run the _cloud-native-spring_ application:
+
[source,bash]
----
CN-Workshop/labs/my_work/cloud-native-spring $ ./mvnw spring-boot:run
----

. Browse to the http://localhost:8080/actuator/health[/health] endpoint and verify that the output is similar to the following (and changes randomly!).
+
[source,json]
----
{
  "status" : "DOWN",
  "flapping" : {
    "status" : "DOWN",
    "flapper" : "failure",
    "random" : 48
  },
  "diskSpace" : {
    "status" : "UP",
    "total" : 499283816448,
    "free" : 133891973120,
    "threshold" : 10485760
  },
  "db" : {
    "status" : "UP",
    "database" : "H2",
    "hello" : 1
  }
}
----

== Metrics

Spring Boot provides a http://localhost:8080/metrics[/metrics] endpoint that exposes several automatically collected metrics for your application. It also allows for the creation of custom metrics.

. Browse to the http://localhost:8080/metrics[/metrics] endpoint. Navigating to /actuator/metrics displays a list of available meter names. You can drill down to view information about a particular meter by providing its name as a selector, e.g. /actuator/metrics/jvm.memory.max.
+
[source,json]
----
{
"names": [
  "hikaricp.connections",
  "hikaricp.connections.acquire",
  "hikaricp.connections.active",
  "hikaricp.connections.creation",
  "hikaricp.connections.idle",
  "hikaricp.connections.max",
  "hikaricp.connections.min",
  "hikaricp.connections.pending",
  "hikaricp.connections.timeout",
  "hikaricp.connections.usage",
  "http.server.requests",
  "jdbc.connections.active",
  "jdbc.connections.idle",
  "jdbc.connections.max",
  "jdbc.connections.min",
  "jvm.buffer.count",
  "jvm.buffer.memory.used",
  "jvm.buffer.total.capacity",
  "jvm.classes.loaded",
  "jvm.classes.unloaded",
  "jvm.gc.live.data.size",
  "jvm.gc.max.data.size",
  "jvm.gc.memory.allocated",
  "jvm.gc.memory.promoted",
  "jvm.gc.pause",
  "jvm.memory.committed",
  "jvm.memory.max",
  "jvm.memory.used",
  "jvm.threads.daemon",
  "jvm.threads.live",
  "jvm.threads.peak",
  "jvm.threads.states",
  "logback.events",
  "process.cpu.usage",
  "process.files.max",
  "process.files.open",
  "process.start.time",
  "process.uptime",
  "spring.data.repository.invocations",
  "system.cpu.count",
  "system.cpu.usage",
  "system.load.average.1m",
  "tomcat.sessions.active.current",
  "tomcat.sessions.active.max",
  "tomcat.sessions.alive.max",
  "tomcat.sessions.created",
  "tomcat.sessions.expired",
  "tomcat.sessions.rejected"
  ]
}
----

. Stop the _cloud-native-spring_ application.

== Deploy _cloud-native-spring_ to Pivotal Cloud Foundry
. Build the application:
+
[source,bash]
----
CN-Workshop/labs/my_work/cloud-native-spring $ ./mvnw package
----

. When running a Spring Boot application on Pivotal Cloud Foundry with the actuator endpoints enabled, you can visualize actuator management information on the Apps Manager dashboard.  To enable this there are a few properties we need to add.
+
Add the following to your Spring Boot configuration:
+
.cloud-native-spring/src/main/resources/application.yml
[source,yaml,subs="verbatim,attributes"]
----
management:
  cloudfoundry:
    enabled: true
    skip-ssl-validation: false
  info:
    git:
      mode: full
      enabled: true
----

. In order to add full build information to your artifact that is pushed to Cloud Foundry, and add the following execution and classifier to the `spring-boot-maven-plugin`:
+
.cloud-native-spring/pom.xml
[source,xml]
----
<executions>
  <execution>
    <goals>
      <goal>build-info</goal>
    </goals>
  </execution>
</executions>
<configuration>
  <classifier>exec</classifier>
</configuration>
----
+
The full plugin config should look like the following:
+
.cloud-native-spring/pom.xml
[source,xml]
----
<project>
  [...]
  <build>
    <plugins>
      [...]
      <plugin>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-maven-plugin</artifactId>
        <executions>
          <execution>
            <goals>
              <goal>build-info</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <classifier>exec</classifier>
        </configuration>
      </plugin>
      [...]
    </plugins>
  </build>
  [...]
</project
----

. By specifying a classifier we actually just produced 2 jars, one that is executable and one that can be used as an artifact that could be included in other apps (such as our Client UI app we'll create later).  Because of this we need to change the name of the jar we included in our manifest.yml file.
+
Change the Cloud Foundry manifest path property to:
+
.cloud-native-spring/manifest.yml
[source,yaml]
----
---
applications:
- name: cloud-native-spring
  random-route: true
  memory: 768M
  path: target/cloud-native-spring-0.0.1-SNAPSHOT-exec.jar # <-- update jar name
  timeout: 180
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
----
. Rebuild the application
+
[source,bash]
----
CN-Workshop/labs/my_work/cloud-native-spring $ ./mvnw package
----

. Push application into Cloud Foundry
+
[source,bash]
----
CN-Workshop/labs/my_work/cloud-native-spring $ cf push
----

. Find the URL created for your app in the health status report and browse to your app.  Also view your application details in the Apps Manager UI:
+
image::images/appsman.jpg[]

. From this UI you can also dynamically change logging levels:
+
image::images/logging.jpg[]

*Congratulations!* You’ve just learned how to add health and metrics to any Spring Boot application.
